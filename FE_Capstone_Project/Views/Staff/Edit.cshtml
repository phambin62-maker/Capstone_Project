@model TourEditModel
@{
    ViewData["Title"] = "Edit Tour";
    Layout = "~/Views/Shared/_StaffLayout.cshtml";
}

<div class="container-fluid">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 mb-1 text-dark">Edit Tour</h1>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb mb-0">
                    <li class="breadcrumb-item"><a href="@Url.Action("Tours")">Tour Management</a></li>
                    <li class="breadcrumb-item"><a href="@Url.Action("TourDetails", new { id = Model.Id })">Tour Details</a></li>
                    <li class="breadcrumb-item active">Edit Tour</li>
                </ol>
            </nav>
        </div>
        <a href="@Url.Action("TourDetails", new { id = Model.Id })" class="btn btn-outline-primary">
            <i class="bi bi-eye me-2"></i>View Details
        </a>
    </div>

    @* @if (TempData["ErrorMessage"] != null)
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <i class="bi bi-exclamation-triangle me-2"></i>@TempData["ErrorMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    } *@

    <!-- Main Form -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-warning text-dark">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-pencil-square me-2"></i>Edit Tour Information
                    </h5>
                </div>
                <div class="card-body">
                    <form method="post" enctype="multipart/form-data" id="tourForm">
                        <input type="hidden" asp-for="Id" />

                        <div class="row">
                            <!-- Basic Information -->
                            <div class="col-lg-6">
                                <div class="card mb-4">
                                    <div class="card-header bg-light">
                                        <h6 class="card-title mb-0">
                                            <i class="bi bi-info-circle me-2"></i>Basic Information
                                        </h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="mb-3">
                                            <label asp-for="Name" class="form-label required">Tour Name</label>
                                            <input asp-for="Name" class="form-control" placeholder="Enter tour name" />
                                            <span asp-validation-for="Name" class="text-danger small"></span>
                                        </div>

                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="mb-3">
                                                    <label asp-for="Price" class="form-label required">Price (VND)</label>
                                                    <div class="input-group">
                                                        <input type="hidden" asp-for="Price" id="rawPrice" asp-format="{0:0}" />
                                                        <input type="text" class="form-control" id="formattedPrice" placeholder="0" />
                                                        <span class="input-group-text">VND</span>
                                                    </div>
                                                    <span asp-validation-for="Price" class="text-danger small"></span>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="mb-3">
                                                    <label asp-for="Duration" class="form-label required">Duration</label>
                                                    <div class="input-group">
                                                        <input asp-for="Duration" type="number" class="form-control" placeholder="0" />
                                                        <span class="input-group-text">days</span>
                                                    </div>
                                                    <span asp-validation-for="Duration" class="text-danger small"></span>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="mb-3">
                                            <label asp-for="Description" class="form-label required">Tour Description</label>
                                            <textarea asp-for="Description" class="form-control"
                                                      style="min-height: 400px; resize: vertical; font-size: 14px; line-height: 1.6; padding: 1rem;"
                                                      placeholder="Enter detailed tour description..."></textarea>
                                            <span asp-validation-for="Description" class="text-danger small"></span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Location & Category -->
                            <div class="col-lg-6">
                                <div class="card mb-4">
                                    <div class="card-header bg-light">
                                        <h6 class="card-title mb-0">
                                            <i class="bi bi-geo-alt me-2"></i>Location & Category
                                        </h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="mb-3">
                                            <label asp-for="StartLocationId" class="form-label required">Start Location</label>
                                            <select asp-for="StartLocationId" class="form-select">
                                                <option value="">-- Select Start Location --</option>
                                                @if (ViewBag.Locations != null)
                                                {
                                                    @foreach (var location in ViewBag.Locations)
                                                    {
                                                        <option value="@location.Id">@location.LocationName</option>
                                                    }
                                                }
                                                else
                                                {
                                                    <option value="">No locations available</option>
                                                }
                                            </select>
                                            <span asp-validation-for="StartLocationId" class="text-danger small"></span>
                                        </div>

                                        <div class="mb-3">
                                            <label asp-for="EndLocationId" class="form-label required">End Location</label>
                                            <select asp-for="EndLocationId" class="form-select">
                                                <option value="">-- Select End Location --</option>
                                                @if (ViewBag.Locations != null)
                                                {
                                                    @foreach (var location in ViewBag.Locations)
                                                    {
                                                        <option value="@location.Id">@location.LocationName</option>
                                                    }
                                                }
                                                else
                                                {
                                                    <option value="">No locations available</option>
                                                }
                                            </select>
                                            <span asp-validation-for="EndLocationId" class="text-danger small"></span>
                                        </div>

                                        <div class="mb-3">
                                            <label asp-for="CategoryId" class="form-label required">Category</label>
                                            <select asp-for="CategoryId" class="form-select">
                                                <option value="">-- Select Category --</option>
                                                @if (ViewBag.Categories != null)
                                                {
                                                    @foreach (var category in ViewBag.Categories)
                                                    {
                                                        <option value="@category.Id">@category.CategoryName</option>
                                                    }
                                                }
                                                else
                                                {
                                                    <option value="">No categories available</option>
                                                }
                                            </select>
                                            <span asp-validation-for="CategoryId" class="text-danger small"></span>
                                        </div>

                                        <div class="mb-3">
                                            <label asp-for="CancelConditionId" class="form-label required">Cancellation Policy</label>
                                            <select asp-for="CancelConditionId" class="form-select">
                                                <option value="">-- Select Cancellation Policy --</option>
                                                @if (ViewBag.CancelConditions != null)
                                                {
                                                    @foreach (var condition in ViewBag.CancelConditions)
                                                    {
                                                        <option value="@condition.Id">@condition.Title</option>
                                                    }
                                                }
                                                else
                                                {
                                                    <option value="">No cancellation policies available</option>
                                                }
                                            </select>
                                            <span asp-validation-for="CancelConditionId" class="text-danger small"></span>
                                        </div>
                                    </div>
                                </div>

                                <!-- Discounts & Capacity -->
                                <div class="card mb-4">
                                    <div class="card-header bg-light">
                                        <h6 class="card-title mb-0">
                                            <i class="bi bi-percent me-2"></i>Discounts & Capacity
                                        </h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="row">
                                            <div class="col-md-4">
                                                <div class="mb-3">
                                                    <label asp-for="ChildDiscount" class="form-label">Child Discount</label>
                                                    <div class="input-group">
                                                        <input asp-for="ChildDiscount" type="number" class="form-control" min="0" max="100" />
                                                        <span class="input-group-text">%</span>
                                                    </div>
                                                    <span asp-validation-for="ChildDiscount" class="text-danger small"></span>
                                                </div>
                                            </div>
                                            <div class="col-md-4">
                                                <div class="mb-3">
                                                    <label asp-for="GroupDiscount" class="form-label">Group Discount</label>
                                                    <div class="input-group">
                                                        <input asp-for="GroupDiscount" type="number" class="form-control" min="0" max="100" />
                                                        <span class="input-group-text">%</span>
                                                    </div>
                                                    <span asp-validation-for="GroupDiscount" class="text-danger small"></span>
                                                </div>
                                            </div>
                                            <div class="col-md-4">
                                                <div class="mb-3">
                                                    <label asp-for="GroupNumber" class="form-label">Group Number</label>
                                                    <input asp-for="GroupNumber" type="number" class="form-control" min="1" max="100" />
                                                    <span asp-validation-for="GroupNumber" class="text-danger small"></span>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="mb-3">
                                                    <label asp-for="MinSeats" class="form-label">Min Seats</label>
                                                    <input asp-for="MinSeats" type="number" class="form-control" min="1" max="1000" />
                                                    <span asp-validation-for="MinSeats" class="text-danger small"></span>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="mb-3">
                                                    <label asp-for="MaxSeats" class="form-label">Max Seats</label>
                                                    <input asp-for="MaxSeats" type="number" class="form-control" min="1" max="1000" />
                                                    <span asp-validation-for="MaxSeats" class="text-danger small"></span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Images Section -->
                        <div class="card mb-4">
                            <div class="card-header bg-light">
                                <h6 class="card-title mb-0">
                                    <i class="bi bi-images me-2"></i>Tour Images
                                </h6>
                            </div>
                            <div class="card-body">
                                <!-- Current Images -->
                                <div class="mb-4">
                                    <label class="form-label">Current Images</label>
                                    <div class="row g-2" id="currentImagesContainer">
                                        @{
                                            var currentImages = ViewBag.CurrentTourImages as List<TourImageViewModel> ?? new List<TourImageViewModel>();
                                            var currentImageCount = currentImages.Count;
                                        }
                                        @if (currentImages != null && currentImageCount > 0)
                                        {
                                            @for (int i = 0; i < currentImageCount; i++)
                                            {
                                                var image = currentImages[i];
                                                var imageUrl = Url.Action("GetTourEditImage", "Staff", new { tourId = Model.Id, imageIndex = i });
                                                // Extract original filename from path (remove GUID prefix if present)
                                                var originalFileName = image.Image;
                                                if (!string.IsNullOrEmpty(originalFileName))
                                                {
                                                     // First get the filename from the path
                                                     var fileNameOnly = System.IO.Path.GetFileName(originalFileName);
                                                     
                                                     // Then try to remove GUID prefix
                                                     var parts = fileNameOnly.Split('_');
                                                     if (parts.Length > 1 && Guid.TryParse(parts[0], out _))
                                                     {
                                                         originalFileName = string.Join("_", parts.Skip(1));
                                                     }
                                                     else 
                                                     {
                                                         originalFileName = fileNameOnly;
                                                     }
                                                }


                                                <div class="col-md-3 col-sm-4 col-6">
                                                    <div class="current-image-container position-relative">
                                                        <img src="@imageUrl"
                                                             class="img-fluid rounded border preview-image"
                                                             style="height: 120px; width: 100%; object-fit: cover; cursor: zoom-in;"
                                                             alt="Current tour image @(i + 1)"
                                                             data-image-src="@imageUrl"
                                                             data-image-index="@i"
                                                             data-image-name="Image @(i + 1)"
                                                             data-original-filename="@originalFileName"
                                                             onerror="this.src='@Url.Action("GetDefaultImage", "Staff")'">
                                                        <div class="position-absolute top-0 end-0 m-1">
                                                            <span class="badge bg-dark bg-opacity-75" style="font-size: 0.6rem;">
                                                                @(i == 0 ? "Main" : (i + 1).ToString())
                                                            </span>
                                                        </div>
                                                        <!-- Nút xóa ảnh -->
                                                        <div class="position-absolute top-0 start-0 m-1">
                                                            <button type="button" class="btn btn-danger btn-sm delete-image-btn"
                                                                    data-image-id="@image.Id"
                                                                    data-image-name="Image @(i + 1)"
                                                                    style="padding: 0.1rem 0.3rem; font-size: 0.6rem;">
                                                                <i class="bi bi-trash"></i>
                                                            </button>
                                                        </div>
                                                    </div>
                                                </div>
                                            }
                                        }
                                        else
                                        {
                                            <div class="col-12 text-center py-4">
                                                <i class="bi bi-image display-4 text-muted"></i>
                                                <p class="text-muted mt-2">No images available for this tour</p>
                                            </div>
                                        }
                                    </div>
                                </div>
                                <!-- Update Images -->
                                <div class="mb-3">
                                    <label asp-for="Images" class="form-label">Add More Images</label>
                                    <input asp-for="Images" type="file" multiple class="form-control" accept="image/*"
                                           id="imageInput" />
                                    <div class="form-text">
                                        <i class="bi bi-info-circle me-1"></i>Select multiple images to add to existing ones.
                                        Hold Ctrl/Cmd to select multiple files.
                                        <br>
                                        <small class="text-muted" id="imageCountInfo">
                                            Current: <span id="currentImageCount">@(ViewBag.CurrentTourImagesCount ?? 0)</span> images
                                        </small>
                                    </div>
                                    <div class="drop-message text-center mt-2 p-2 border rounded bg-light">
                                        <i class="bi bi-cloud-arrow-up display-6 text-muted mb-2"></i>
                                        <p class="mb-1">Drag and drop images here</p>
                                        <small class="text-muted">or click to browse</small>
                                    </div>
                                    <span asp-validation-for="Images" class="text-danger small"></span>
                                    <div id="imageUploadError" class="alert alert-danger mt-2" style="display: none;">
                                        <i class="bi bi-exclamation-triangle-fill me-2"></i><span id="imageUploadErrorMessage"></span>
                                    </div>
                                    <div id="imagePreview" class="row g-2 mt-3" style="display: none;">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Form Actions -->
                        <div class="d-flex justify-content-between align-items-center border-top pt-4">
                            <div>
                                <a href="@Url.Action("TourDetails", new { id = Model.Id })" class="btn btn-outline-secondary me-2">
                                    <i class="bi bi-eye me-2"></i>View Details
                                </a>
                                <a href="@Url.Action("Tours")" class="btn btn-outline-secondary">
                                    <i class="bi bi-x-circle me-2"></i>Cancel
                                </a>
                            </div>
                            <button type="submit" class="btn btn-warning px-4">
                                <i class="bi bi-check-circle me-2"></i>Update Tour
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Image Preview Modal -->
<div class="modal fade" id="imagePreviewModal" tabindex="-1" aria-labelledby="imagePreviewModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-dark text-white">
                <h5 class="modal-title" id="imagePreviewModalLabel">Image Preview</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center p-0">
                <img id="previewModalImage" src="" alt="Preview" class="img-fluid" style="max-height: 70vh; object-fit: contain;">
            </div>
            <div class="modal-footer bg-light">
                <div class="me-auto">
                    <span id="currentImageIndex" class="badge bg-primary">1</span>
                    <span id="totalImages" class="text-muted">/ 0</span>
                </div>
                <button type="button" class="btn btn-outline-secondary" id="prevImage">
                    <i class="bi bi-chevron-left"></i> Previous
                </button>
                <button type="button" class="btn btn-outline-secondary" id="nextImage">
                    Next <i class="bi bi-chevron-right"></i>
                </button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
        // Biến toàn cục để theo dõi số lượng ảnh
        let currentImageCount = @(ViewBag.CurrentTourImagesCount ?? 0);
        const MAX_TOTAL_IMAGES = 10;

        // Biến cho chức năng preview ảnh
        let currentPreviewIndex = 0;
        let previewImages = [];
        let newPreviewImages = []; // Ảnh mới upload (previews)
        let newSelectedFiles = []; // Các đối tượng File thực tế

        $(document).ready(function () {
            // Auto-select current values in dropdowns
            @if (Model.StartLocationId > 0)
            {
                    <text>$('#StartLocationId').val('@Model.StartLocationId');</text>
            }
            @if (Model.EndLocationId > 0)
            {
                    <text>$('#EndLocationId').val('@Model.EndLocationId');</text>
            }
            @if (Model.CategoryId > 0)
            {
                    <text>$('#CategoryId').val('@Model.CategoryId');</text>
            }
            @if (Model.CancelConditionId > 0)
            {
                    <text>$('#CancelConditionId').val('@Model.CancelConditionId');</text>
            }

            // Handle image file selection
            $('#imageInput').on('change', function(e) {
                handleImageSelection(e);
            });

            // Real-time validation
            $('input, select, textarea').on('blur', function () {
                $(this).addClass('validated');
            });
            updateSelectedFilesCount($('#imageInput')[0].files);
            // Cập nhật thông tin số lượng ảnh
            updateImageCountInfo();

            // Thêm drag and drop functionality
            setupDragAndDrop();

            // Khởi tạo chức năng preview ảnh
            initializeImagePreview();

            // Custom validation for identical locations
            if ($.validator) {
                // Configure jQuery validation to not ignore our hidden price field
                $.validator.setDefaults({ ignore: ":hidden:not(#rawPrice)" });

                $.validator.addMethod("notEqualTo", function (value, element, param) {
                    return this.optional(element) || value !== $(param).val();
                }, "End location must be different from start location");

                $('#EndLocationId').rules("add", {
                    notEqualTo: "#StartLocationId"
                });
            }

            // Location change events
            $('#StartLocationId').on('change', function () {
                if ($('#EndLocationId').val()) {
                    $('#EndLocationId').valid();
                }
            });
            $('#EndLocationId').on('change', function () {
                if ($('#StartLocationId').val()) {
                    $('#StartLocationId').valid();
                }
            });

            // Pricing formatting
            initializePriceFormatting();
        });

        // Pricing formatting logic
        function initializePriceFormatting() {
            const rawPrice = document.getElementById('rawPrice');
            const formattedPrice = document.getElementById('formattedPrice');

            if (!rawPrice || !formattedPrice) return;

            // Configure jQuery validation to not ignore our hidden price field
            if ($.validator) {
                $.validator.setDefaults({ ignore: ":hidden:not(#rawPrice)" });
            }

            // Utility functions
            const formatPrice = (value) => {
                if (!value && value !== 0) return '';
                // Get only integer part (strip .00 etc)
                let stringValue = value.toString().split('.')[0];
                return stringValue.replace(/\B(?=(\d{3})+(?!\d))/g, ".");
            };

            // Initial format and validation sync
            if (rawPrice.value) {
                formattedPrice.value = formatPrice(rawPrice.value);
                
                // Trigger initial validation sync
                setTimeout(() => {
                    if ($('#tourForm').data('validator')) {
                        $(rawPrice).valid();
                    }
                }, 100);
            }

            formattedPrice.addEventListener('input', (e) => {
                let value = e.target.value.replace(/[^0-9]/g, '');
                rawPrice.value = value;
                e.target.value = formatPrice(value);

                // Trigger validation on hidden field and sync style
                if ($('#tourForm').data('validator')) {
                    const isValid = $(rawPrice).valid();
                    if (!isValid) {
                        formattedPrice.classList.add('is-invalid');
                    } else {
                        formattedPrice.classList.remove('is-invalid');
                    }
                }
            });
        }

        // Khởi tạo chức năng preview ảnh
        function initializeImagePreview() {
            // Thu thập tất cả ảnh hiện có
            previewImages = [];
            $('.current-image-container .preview-image').each(function(index) {
                previewImages.push({
                    src: $(this).data('image-src'),
                    index: index,
                    name: $(this).data('image-name'),
                    type: 'existing'
                });
            });

            // Cập nhật tổng số ảnh trong modal
            updateTotalImagesCount();

            // Xử lý click vào ảnh để preview
            $(document).on('click', '.preview-image', function() {
                const imageSrc = $(this).attr('src');
                const imageName = $(this).data('image-name') || $(this).attr('alt');
                openImagePreview(imageSrc, imageName);
            });

            // Navigation controls
            $('#prevImage').on('click', function() {
                navigateImage(-1);
            });

            $('#nextImage').on('click', function() {
                navigateImage(1);
            });

            // Keyboard navigation
            $(document).on('keydown', function(e) {
                if ($('#imagePreviewModal').hasClass('show')) {
                    switch(e.key) {
                        case 'ArrowLeft':
                            navigateImage(-1);
                            break;
                        case 'ArrowRight':
                            navigateImage(1);
                            break;
                        case 'Escape':
                            $('#imagePreviewModal').modal('hide');
                            break;
                    }
                }
            });

            // Reset modal khi đóng
            $('#imagePreviewModal').on('hidden.bs.modal', function() {
                currentPreviewIndex = 0;
                $('#prevImage').show();
                $('#nextImage').show();
            });
        }

        // Mở preview ảnh
        function openImagePreview(imageSrc, imageName) {
            // Tìm index của ảnh trong cả hai mảng
            const allImages = [...previewImages, ...newPreviewImages];
            currentPreviewIndex = allImages.findIndex(img => img.src === imageSrc);

            if (currentPreviewIndex === -1) {
                // Nếu không tìm thấy, xem như ảnh đơn lẻ
                currentPreviewIndex = 0;
                $('#prevImage').hide();
                $('#nextImage').hide();
                $('#totalImages').text('/ 1');
            } else {
                // Nếu tìm thấy, hiển thị navigation
                $('#prevImage').show();
                $('#nextImage').show();
                updateTotalImagesCount();
            }

            $('#previewModalImage').attr('src', imageSrc);
            $('#currentImageIndex').text(currentPreviewIndex + 1);
            $('#imagePreviewModalLabel').text(imageName || 'Image Preview');

            // Cập nhật trạng thái nút navigation
            updateNavigationButtons();

            $('#imagePreviewModal').modal('show');
        }

        // Điều hướng giữa các ảnh
        function navigateImage(direction) {
            const allImages = [...previewImages, ...newPreviewImages];
            const newIndex = currentPreviewIndex + direction;

            if (newIndex >= 0 && newIndex < allImages.length) {
                currentPreviewIndex = newIndex;
                const image = allImages[newIndex];

                $('#previewModalImage').attr('src', image.src);
                $('#currentImageIndex').text(currentPreviewIndex + 1);
                $('#imagePreviewModalLabel').text(image.name);

                updateNavigationButtons();
            }
        }

        // Cập nhật trạng thái nút navigation
        function updateNavigationButtons() {
            const allImages = [...previewImages, ...newPreviewImages];
            $('#prevImage').prop('disabled', currentPreviewIndex === 0);
            $('#nextImage').prop('disabled', currentPreviewIndex === allImages.length - 1);
        }

        // Cập nhật tổng số ảnh
        function updateTotalImagesCount() {
            const totalImages = previewImages.length + newPreviewImages.length;
            $('#totalImages').text('/ ' + totalImages);
        }

        // Setup drag and drop
        function setupDragAndDrop() {
            const dropArea = $('#imageInput').closest('.card-body');
            const input = $('#imageInput')[0];

            // Prevent default drag behaviors
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                dropArea.on(eventName, preventDefaults);
            });

            // Highlight drop area when item is dragged over it
            ['dragenter', 'dragover'].forEach(eventName => {
                dropArea.on(eventName, function() {
                    $(this).addClass('highlight');
                });
            });

            ['dragleave', 'drop'].forEach(eventName => {
                dropArea.on(eventName, function() {
                    $(this).removeClass('highlight');
                });
            });

            // Handle dropped files
            dropArea.on('drop', function(e) {
                const dt = e.originalEvent.dataTransfer;
                const files = dt.files;

                // Update file input
                input.files = files;

                // Trigger change event
                $('#imageInput').trigger('change');
            });

            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }
        }

        // Cập nhật thông tin số lượng ảnh
        function updateImageCountInfo() {
            $('#currentImageCount').text(currentImageCount);

            if (currentImageCount >= MAX_TOTAL_IMAGES) {
                $('#imageCountInfo').addClass('text-danger');
                $('#imageInput').prop('disabled', true);
                $('.drop-message').hide();
            } else {
                $('#imageCountInfo').removeClass('text-danger');
                $('#imageInput').prop('disabled', false);
                $('.drop-message').show();
            }
            
            // Clear the "Will be..." message when just updating count normally
            $('#willBeMessage').remove(); 
        }

        // Cập nhật thông tin tổng số ảnh dự kiến
        function updateTotalAfterUpload(total) {
            // First ensure standard state
            $('#currentImageCount').text(currentImageCount);
            
            // Then add the projection message
            if (total !== currentImageCount) {
                 // Check if message already exists
                 if ($('#willBeMessage').length === 0) {
                     $('#imageCountInfo').append(`<br><span class="text-primary small" id="willBeMessage">Will be ${total} after upload</span>`);
                 } else {
                     $('#willBeMessage').text(`Will be ${total} after upload`);
                 }
            } else {
                $('#willBeMessage').remove();
            }
        }

                $(document).on('click', '.delete-image-btn', function() {
            const imageId = $(this).data('image-id');
            const imageName = $(this).data('image-name');
            const button = $(this);

            console.log('=== DELETE IMAGE DEBUG ===');
            console.log('Image ID:', imageId);
            console.log('Image Name:', imageName);

            if (!confirm(`Are you sure you want to delete ${imageName}?`)) {
                return;
            }

            button.html('<span class="spinner-border spinner-border-sm"></span>').prop('disabled', true);

            $.ajax({
                url: '@Url.Action("DeleteTourImage", "Staff")',
                type: 'POST',
                data: { imageId: imageId },
                success: function(result) {
                    console.log('=== SUCCESS RESPONSE ===');
                    console.log('Full response:', result);
                    console.log('Success:', result.success);
                    console.log('Message:', result.message);

                    if (result.success) {
                        showSuccessMessage(result.message || 'Image deleted successfully!');
                        currentImageCount--;
                        updateImageCountInfo();

                        button.closest('.col-md-3, .col-sm-4, .col-6').fadeOut(300, function() {
                            $(this).remove();

                            const remainingImages = $('.current-image-container').length;
                            if (remainingImages === 0) {
                                $('#currentImagesContainer').html(`
                                    <div class="col-12 text-center py-4">
                                        <i class="bi bi-image display-4 text-muted"></i>
                                        <p class="text-muted mt-2">No images available for this tour</p>
                                    </div>
                                `);
                            }
                        });
                    } else {
                        console.error('Server returned success: false');
                        throw new Error(result.message || 'Failed to delete image');
                    }
                },
                error: function(xhr, status, error) {
                    console.error('=== AJAX ERROR ===');
                    console.error('Status:', status);
                    console.error('Error:', error);
                    console.error('Response Text:', xhr.responseText);

                    showErrorMessage('Failed to delete image: ' + error);
                    button.html('<i class="bi bi-trash"></i>').prop('disabled', false);
                }
            });
        });

        // Handle new image selection với multiple files
        function handleImageSelection(e) {
            const files = e.target.files;
            const previewContainer = $('#imagePreview');
            previewContainer.empty().hide();
            newPreviewImages = []; // Reset ảnh mới

            // Cập nhật thông tin số file đã chọn
            updateSelectedFilesCount(files);

            if (!files || files.length === 0) {
                return;
            }

            // Kiểm tra tổng số ảnh
            const totalAfterUpload = currentImageCount + newSelectedFiles.length + files.length;
            if (totalAfterUpload > MAX_TOTAL_IMAGES) {
                alert(`Cannot upload ${files.length} images. You currently have ${currentImageCount + newSelectedFiles.length} images. Maximum total is ${MAX_TOTAL_IMAGES} images.`);
                e.target.value = '';
                updateSelectedFilesCount(newSelectedFiles); // Show existing count
                return;
            }

            let validFiles = true;
            let errorMessage = '';

            // Collect existing filenames for duplicate check
            const existingFilenames = new Set();
            $('.current-image-container .preview-image').each(function() {
                const name = $(this).data('original-filename');
                if (name) existingFilenames.add(name.toLowerCase());
            });

            // Validate and filter files
            const dt = new DataTransfer();
            const filesToProcess = [];

            for (let i = 0; i < files.length; i++) {
                const file = files[i];

                // Check for duplicates - Silent Skip
                if (existingFilenames.has(file.name.toLowerCase())) {
                    console.log(`Skipping duplicate file: ${file.name}`);
                    continue;
                }

                // Check file size (5MB limit)
                if (file.size > 5 * 1024 * 1024) {
                    errorMessage = `File "${file.name}" is too large. Maximum size is 5MB.`;
                    validFiles = false;
                    break;
                }

                // Check file type
                if (!file.type.startsWith('image/')) {
                    errorMessage = `File "${file.name}" is not an image. Please select image files only.`;
                    validFiles = false;
                    break;
                }
                
                dt.items.add(file);
                filesToProcess.push(file);
            }

            if (!validFiles) {
                // Show error in the container
                $('#imageUploadErrorMessage').text(errorMessage);
                $('#imageUploadError').fadeIn();
                
                // Auto hide after 5 seconds
                setTimeout(function() {
                    $('#imageUploadError').fadeOut();
                }, 5000);

                e.target.value = '';
                updateSelectedFilesCount(null); // Reset count
                return;
            } else {
                $('#imageUploadError').hide();
            }
            
            // Update internal file list
            newSelectedFiles = [...newSelectedFiles, ...filesToProcess];
            updateSelectedFilesCount(newSelectedFiles);

            // Show preview for filtered files
            for (let i = 0; i < filesToProcess.length; i++) {
                const file = filesToProcess[i];
                const reader = new FileReader();

                reader.onload = function(e) {
                    const fileSize = (file.size / 1024 / 1024).toFixed(2);
                    const previewIndex = newPreviewImages.length;

                    // Thêm vào danh sách ảnh mới
                    newPreviewImages.push({
                        src: e.target.result,
                        index: previewImages.length + previewIndex,
                        name: file.name,
                        type: 'new',
                        fileIndex: i, // Lưu index gốc của file (Note: indices might shift if multiple batches, but simplistic here)
                        previewIndex: previewIndex // Thêm previewIndex
                    });

                    const previewHtml = `
                        <div class="col-md-3 col-sm-4 col-6" data-preview-index="${previewIndex}">
                            <div class="preview-image-container position-relative">
                                <img src="${e.target.result}"
                                     class="img-fluid rounded border preview-image"
                                     style="height: 120px; width: 100%; object-fit: cover; cursor: zoom-in;"
                                     alt="Preview ${file.name}"
                                     data-file-index="${i}">
                                <div class="position-absolute top-0 end-0 m-1">
                                    <span class="badge bg-success" style="font-size: 0.6rem;">${previewIndex + 1}</span>
                                </div>
                                <div class="position-absolute bottom-0 start-0 end-0 bg-dark bg-opacity-75 text-white text-center py-1">
                                    <small class="d-block text-truncate px-1">${file.name}</small>
                                    <small class="d-block">${fileSize} MB</small>
                                </div>
                                <div class="position-absolute top-0 start-0 m-1">
                                    <button type="button" class="btn btn-warning btn-sm remove-preview-btn"
                                            data-preview-index="${previewIndex}"
                                            data-file-index="${i}"
                                            style="padding: 0.1rem 0.3rem; font-size: 0.6rem;">
                                        <i class="bi bi-x"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                    previewContainer.append(previewHtml).show();
                };
                reader.readAsDataURL(file);
            }

            // Cập nhật thông tin tổng số ảnh sau khi upload
            const realTotalAfterUpload = currentImageCount + newSelectedFiles.length;
            updateTotalAfterUpload(realTotalAfterUpload);
            updateTotalImagesCount();
        }

        // Cập nhật thông tin số file đã chọn
        function updateSelectedFilesCount(files) {
            $('#selectedFilesCount').remove();

            if (files && files.length > 0) {
                $('#imageInput').after(`<div id="selectedFilesCount" class="text-success small mt-1"><i class="bi bi-check-circle me-1"></i>Selected ${files.length} file(s)</div>`);
            } else {
                // Nếu không có file, thêm thông báo không có file nào được chọn
                $('#imageInput').after(`<div id="selectedFilesCount" class="text-muted small mt-1"><i class="bi bi-info-circle me-1"></i>No files selected</div>`);
            }
        }

        // Xử lý xóa preview ảnh mới
        $(document).on('click', '.remove-preview-btn', function(e) {
            e.stopPropagation();

            const previewIndex = parseInt($(this).data('preview-index'));
            const fileIndex = parseInt($(this).data('file-index'));
            const input = $('#imageInput')[0];

            console.log('Removing preview:', { previewIndex, fileIndex, filesCount: input.files.length });

            // Xóa khỏi danh sách ảnh mới
            newPreviewImages = newPreviewImages.filter(img => img.previewIndex !== previewIndex);

            // Cập nhật FileList nếu cần thiết (nhưng chúng ta sẽ sync lúc submit)
            // Tuy nhiên, xóa khỏi newSelectedFiles là quan trọng nhất
            newSelectedFiles.splice(previewIndex, 1);

            // Xóa preview khỏi DOM
            const previewElement = $(`[data-preview-index="${previewIndex}"]`);
            if (previewElement.length) {
                previewElement.remove();
            }

            // Cập nhật lại index cho các preview còn lại
            const remainingPreviews = $('#imagePreview .col-md-3, #imagePreview .col-sm-4, #imagePreview .col-6');
            remainingPreviews.each(function(index) {
                const newPreviewIndex = index;
                $(this).attr('data-preview-index', newPreviewIndex);
                $(this).find('.remove-preview-btn').attr('data-preview-index', newPreviewIndex);
                $(this).find('.badge').text(newPreviewIndex + 1);

                // Cập nhật lại newPreviewImages với index mới
                const imgIndex = newPreviewImages.findIndex(img =>
                    $(this).find('.preview-image').attr('src') === img.src
                );
                if (imgIndex !== -1) {
                    newPreviewImages[imgIndex].previewIndex = newPreviewIndex;
                    newPreviewImages[imgIndex].fileIndex = parseInt($(this).find('.remove-preview-btn').data('file-index'));
                }
            });

            // Cập nhật thông tin số file
            updateSelectedFilesCount(input.files);
            updateTotalImagesCount();

            // Nếu không còn preview nào, ẩn container
            if (newPreviewImages.length === 0) {
                $('#imagePreview').hide();
                $('#totalAfterUpload').remove();
            } else {
                // Cập nhật thông tin tổng số ảnh sau khi upload
                const totalAfterUpload = currentImageCount + newSelectedFiles.length;
                updateTotalAfterUpload(totalAfterUpload);
            }
        });

        // Cập nhật thông tin tổng số ảnh sau khi upload
        function updateTotalAfterUpload(totalAfterUpload) {
            $('#totalAfterUpload').remove();
            if (totalAfterUpload > currentImageCount) {
                $('#imageCountInfo').after(
                    `<small class="text-success" id="totalAfterUpload"><i class="bi bi-arrow-right me-1"></i>Will be <strong>${totalAfterUpload}</strong> after upload</small>`
                );
            }
        }

        // Form validation before submit
        $('#tourForm').on('submit', function(e) {
            const files = newSelectedFiles;
            const totalAfterUpload = currentImageCount + files.length;

            // Kiểm tra tổng số ảnh
            if (totalAfterUpload > MAX_TOTAL_IMAGES) {
                e.preventDefault();
                alert(`Cannot upload ${files.length} images. Total would be ${totalAfterUpload}, maximum allowed is ${MAX_TOTAL_IMAGES}.`);
                return;
            }

            // Validate file sizes
            for (let i = 0; i < files.length; i++) {
                if (files[i].size > 5 * 1024 * 1024) {
                    e.preventDefault();
                    alert(`File "${files[i].name}" is too large. Maximum size is 5MB.`);
                    return;
                }
            }

            // Kiểm tra nếu không có file mới nào được chọn nhưng vẫn hiển thị preview (trường hợp lỗi)
            if (files.length === 0 && newPreviewImages.length > 0) {
                // Reset state
                newPreviewImages = [];
                $('#imagePreview').empty().hide();
            }

            // Sync newSelectedFiles back to the input element before submitting
            const dt = new DataTransfer();
            newSelectedFiles.forEach(file => dt.items.add(file));
            $('#imageInput')[0].files = dt.files;

            // Show loading state
            $('button[type="submit"]').html(`
                <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                Updating Tour...
            `).prop('disabled', true);
        });

        // Helper functions for messages
        function showSuccessMessage(message) {
            $('.custom-alert').remove();
            const alertHtml = `
                <div class="alert alert-success alert-dismissible fade show custom-alert position-fixed"
                     style="top: 20px; right: 20px; z-index: 9999; min-width: 300px;">
                    <i class="bi bi-check-circle me-2"></i>${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
            $('body').append(alertHtml);
            setTimeout(() => $('.custom-alert').alert('close'), 5000);
        }

        function showErrorMessage(message) {
            $('.custom-alert').remove();
            const alertHtml = `
                <div class="alert alert-danger alert-dismissible fade show custom-alert position-fixed"
                     style="top: 20px; right: 20px; z-index: 9999; min-width: 300px;">
                    <i class="bi bi-exclamation-triangle me-2"></i>${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
            $('body').append(alertHtml);
            setTimeout(() => $('.custom-alert').alert('close'), 5000);
        }
    </script>

    <style>
        .required::after {
            content: " *";
            color: #dc3545;
        }

        .form-label {
            font-weight: 500;
            color: #495057;
            margin-bottom: 0.5rem;
        }

        .card {
            border: 1px solid #e3e6f0;
            box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15);
        }

        .card-header {
            border-bottom: 1px solid #e3e6f0;
        }

        input.validated:invalid {
            border-color: #dc3545;
        }

        input.validated:valid {
            border-color: #198754;
        }

        .form-text {
            font-size: 0.875rem;
            color: #6c757d;
        }

        .current-image-container, .preview-image-container {
            transition: transform 0.2s ease;
        }

            .current-image-container:hover, .preview-image-container:hover {
                transform: scale(1.05);
            }

        .preview-image {
            cursor: zoom-in;
            transition: all 0.3s ease;
        }

            .preview-image:hover {
                opacity: 0.8;
                box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            }

        .description-textarea {
            min-height: 400px;
            resize: vertical;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            font-size: 14px;
            line-height: 1.6;
            padding: 1rem;
            border: 2px solid #e9ecef;
            transition: all 0.3s ease;
        }

            .description-textarea:focus {
                border-color: #86b7fe;
                box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
                background-color: #f8f9fa;
            }

            .description-textarea:hover {
                border-color: #adb5bd;
            }

        /* Image Preview Modal Styles */
        #imagePreviewModal .modal-content {
            border: none;
            border-radius: 10px;
            overflow: hidden;
        }

        #imagePreviewModal .modal-header {
            border-bottom: 1px solid #444;
        }

        #imagePreviewModal .modal-footer {
            border-top: 1px solid #dee2e6;
        }

        #previewModalImage {
            border-radius: 5px;
            max-width: 100%;
        }

        /* Responsive adjustments */
        @@media (max-width: 768px) {
            .description-textarea {
                min-height: 300px;
                font-size: 16px;
            }

            #imagePreviewModal .modal-dialog {
                margin: 10px;
            }

            #imagePreviewModal .modal-footer .btn {
                font-size: 0.875rem;
                padding: 0.375rem 0.75rem;
            }

            #imagePreviewModal .modal-footer {
                flex-wrap: wrap;
                gap: 0.5rem;
            }

                #imagePreviewModal .modal-footer .btn {
                    flex: 1;
                    min-width: 100px;
                }
        }

        /* Custom alert styles */
        .custom-alert {
            animation: slideInRight 0.3s ease-out;
        }

        @@keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .remove-preview-btn {
            background: rgba(255, 193, 7, 0.9);
            border: none;
            color: #000;
        }

            .remove-preview-btn:hover {
                background: rgba(255, 193, 7, 1);
            }

        /* Style cho thông tin số lượng ảnh */
        #imageCountInfo {
            font-weight: 500;
        }

        .card-body.highlight {
            background-color: rgba(0, 123, 255, 0.1);
            border: 2px dashed #007bff;
        }

        .drop-message {
            font-size: 0.875rem;
            color: #6c757d;
            margin-top: 0.5rem;
        }

        /* Style cho preview images */
        .preview-image-container {
            transition: all 0.3s ease;
        }

            .preview-image-container:hover {
                transform: translateY(-2px);
                box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            }

        /* Style cho file input */
        #imageInput {
            cursor: pointer;
        }

        #selectedFilesCount {
            font-weight: 500;
        }

        /* Navigation button styles */
        #prevImage:disabled,
        #nextImage:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
    </style>
}