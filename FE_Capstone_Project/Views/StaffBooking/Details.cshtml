@using BE_Capstone_Project.Domain.Enums
@model StaffBookingDTO
@{
    ViewData["Title"] = $"Chi tiết Booking #{Model.Id}";
    Layout = "~/Views/Shared/_StaffLayout.cshtml";

    // Kiểm tra xem booking có thể chỉnh sửa không
    bool isEditable = IsBookingEditable(Model.BookingStatus, Model.PaymentStatus);
    string editableClass = isEditable ? "" : "opacity-50";
    string editableTooltip = isEditable ? "" : "Booking không thể chỉnh sửa do đã ở trạng thái cuối cùng";
}

<div class="container-fluid">
    <!-- Header -->
    <div class="d-sm-flex align-items-center justify-content-between mb-4">
        <h1 class="h3 mb-0 text-gray-800">
            <i class="fas fa-calendar-check me-2"></i>Chi tiết Booking #@Model.Id
        </h1>
        <div class="d-flex gap-2">
            <a href="@Url.Action("Bookings")" class="btn btn-secondary">
                <i class="fas fa-arrow-left me-1"></i>Quay lại danh sách
            </a>
        </div>
    </div>


    <!-- Thông báo booking đã khóa -->
    @if (!isEditable)
    {
        <div class="alert alert-info alert-dismissible fade show" role="alert">
            <i class="fas fa-info-circle me-2"></i>
            <strong>Booking đã kết thúc:</strong> Không thể thay đổi trạng thái khi booking đã hoàn thành, hủy hoặc đã hoàn tiền.
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }

    <div class="row">
        <!-- Thông tin chính -->
        <div class="col-lg-8">
            <!-- Thông tin booking -->
            <div class="card shadow mb-4 @editableClass">
                <div class="card-header py-3 d-flex justify-content-between align-items-center">
                    <h6 class="m-0 font-weight-bold text-primary">
                        <i class="fas fa-info-circle me-2"></i>Thông tin Booking
                    </h6>
                    <span class="badge @GetBookingStatusBadge(Model.BookingStatus) fs-6">
                        @GetBookingStatusText(Model.BookingStatus)
                    </span>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <table class="table table-borderless">
                                <tr>
                                    <td class="fw-bold text-muted" width="40%">Mã booking:</td>
                                    <td class="fw-bold text-dark">#@Model.Id</td>
                                </tr>
                                <tr>
                                    <td class="fw-bold text-muted">Tour:</td>
                                    <td>@Model.TourName</td>
                                </tr>
                                <tr>
                                    <td class="fw-bold text-muted">Ngày khởi hành:</td>
                                    <td>
                                        <i class="fas fa-plane-departure text-primary me-2"></i>
                                        @Model.DepartureDate?.ToString("dd/MM/yyyy HH:mm")
                                    </td>
                                </tr>
                                <tr>
                                    <td class="fw-bold text-muted">Ngày kết thúc:</td>
                                    <td>
                                        <i class="fas fa-plane-arrival text-success me-2"></i>
                                        @Model.ArrivalDate?.ToString("dd/MM/yyyy HH:mm")
                                    </td>
                                </tr>
                            </table>
                        </div>
                        <div class="col-md-6">
                            <table class="table table-borderless">
                                <tr>
                                    <td class="fw-bold text-muted" width="40%">Ngày booking:</td>
                                    <td>
                                        <i class="fas fa-calendar text-info me-2"></i>
                                        @Model.BookingDate?.ToString("dd/MM/yyyy HH:mm")
                                    </td>
                                </tr>
                                <tr>
                                    <td class="fw-bold text-muted">Số lượng:</td>
                                    <td>
                                        <div class="d-flex gap-3">
                                            <span class="badge bg-primary">
                                                <i class="fas fa-user me-1"></i>@Model.AdultCount Người lớn
                                            </span>
                                            <span class="badge bg-info">
                                                <i class="fas fa-child me-1"></i>@Model.ChildCount Trẻ em
                                            </span>
                                            <span class="badge bg-secondary">
                                                <i class="fas fa-baby me-1"></i>@Model.InfantCount Em bé
                                            </span>
                                        </div>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="fw-bold text-muted">Tổng tiền:</td>
                                    <td class="h5 text-success fw-bold">
                                        @Model.TotalPrice?.ToString("N0") ₫
                                    </td>
                                </tr>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Thông tin khách hàng -->
            <div class="card shadow mb-4 @editableClass">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">
                        <i class="fas fa-user me-2"></i>Thông tin Khách hàng
                    </h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <table class="table table-borderless">
                                <tr>
                                    <td class="fw-bold text-muted" width="40%">Họ tên:</td>
                                    <td class="fw-bold text-dark">@Model.FullName</td>
                                </tr>
                                <tr>
                                    <td class="fw-bold text-muted">Username:</td>
                                    <td>
                                        <i class="fas fa-user-circle text-secondary me-2"></i>
                                        @Model.UserName
                                    </td>
                                </tr>
                                <tr>
                                    <td class="fw-bold text-muted">Email:</td>
                                    <td>
                                        <i class="fas fa-envelope text-primary me-2"></i>
                                        <a href="mailto:@Model.Email" class="text-decoration-none">@Model.Email</a>
                                    </td>
                                </tr>
                            </table>
                        </div>
                        <div class="col-md-6">
                            <table class="table table-borderless">
                                <tr>
                                    <td class="fw-bold text-muted" width="40%">Số điện thoại:</td>
                                    <td>
                                        <i class="fas fa-phone text-success me-2"></i>
                                        <a href="tel:@Model.PhoneNumber" class="text-decoration-none">@Model.PhoneNumber</a>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="fw-bold text-muted">Trạng thái thanh toán:</td>
                                    <td>
                                        <span class="badge @GetPaymentStatusBadge(Model.PaymentStatus) fs-6">
                                            @GetPaymentStatusText(Model.PaymentStatus)
                                        </span>
                                    </td>
                                </tr>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sidebar - Status & Actions -->
        <div class="col-lg-4">
            <!-- Cập nhật trạng thái -->
            <div class="card shadow mb-4 @editableClass"
                 @if (!isEditable)
                {
                     <text>data-bs-toggle="tooltip" title="@editableTooltip"</text>
                 }
>
                <div class="card-header py-3 d-flex justify-content-between align-items-center">
                    <h6 class="m-0 font-weight-bold text-primary">
                        <i class="fas fa-edit me-2"></i>Cập nhật trạng thái
                    </h6>
                    @if (!isEditable)
                    {
                            <span class="badge bg-secondary">
                                <i class="fas fa-lock me-1"></i>Đã khóa
                            </span>
                    }
                </div>
                <div class="card-body">
                    <!-- Update Booking Status -->
                    <form method="post" action="@Url.Action("UpdateBookingStatus", new { id = Model.Id })"
                          class="ajax-form" data-success-message="Cập nhật trạng thái booking thành công!">
                        @Html.AntiForgeryToken()
                        <div class="mb-3">
                            <label for="BookingStatus" class="form-label fw-bold">
                                <i class="fas fa-calendar-check me-1"></i>Trạng thái Booking
                            </label>
                            <select class="form-control" id="BookingStatus" name="BookingStatus" required
                                    @if (!isEditable)
                                    {
                                        <text>disabled</text>
                                    }
>
                                @foreach (var status in ViewBag.BookingStatuses)
                                {
                                        <option value="@status" selected="@(status == Model.BookingStatus)">
                                            @GetBookingStatusText(status)
                                        </option>
                                }
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="BookingNote" class="form-label fw-bold">
                                <i class="fas fa-sticky-note me-1"></i>Ghi chú (tùy chọn)
                            </label>
                            <textarea class="form-control" id="BookingNote" name="Note" rows="2"
                                      placeholder="Nhập ghi chú về thay đổi trạng thái..."
                                      @if (!isEditable) {
                                      <text>disabled</text>
                                      }
></textarea>
                        </div>
                        <button type="submit" class="btn btn-primary w-100"
                                @if (!isEditable)
                                {
                                    <text>disabled</text>
                                }
>
                            <i class="fas fa-save me-1"></i>
                            @if (isEditable)
                            {
                                    <text>Cập nhật Booking</text>
                            }
                            else
                            {
                                    <text>Đã khóa</text>
                            }
                        </button>
                    </form>

                    <hr class="my-4">

                    <!-- Update Payment Status -->
                    <form method="post" action="@Url.Action("UpdatePaymentStatus", new { id = Model.Id })"
                          class="ajax-form" data-success-message="Cập nhật trạng thái thanh toán thành công!">
                        @Html.AntiForgeryToken()
                        <div class="mb-3">
                            <label for="PaymentStatus" class="form-label fw-bold">
                                <i class="fas fa-money-bill-wave me-1"></i>Trạng thái Thanh toán
                            </label>
                            <select class="form-control" id="PaymentStatus" name="PaymentStatus" required
                                    @if (!isEditable)
                                    {
                                        <text>disabled</text>
                                    }
>
                                @foreach (var status in ViewBag.PaymentStatuses)
                                {
                                        <option value="@status" selected="@(status == Model.PaymentStatus)">
                                            @GetPaymentStatusText(status)
                                        </option>
                                }
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="PaymentNote" class="form-label fw-bold">
                                <i class="fas fa-sticky-note me-1"></i>Ghi chú (tùy chọn)
                            </label>
                            <textarea class="form-control" id="PaymentNote" name="Note" rows="2"
                                      placeholder="Nhập ghi chú về thanh toán..."
                                      @if (!isEditable) {
                                      <text>disabled</text>
                                      }
></textarea>
                        </div>
                        <button type="submit" class="btn btn-success w-100"
                                @if (!isEditable)
                                {
                                    <text>disabled</text>
                                }
>
                            <i class="fas fa-money-bill-wave me-1"></i>
                            @if (isEditable)
                            {
                                    <text>Cập nhật Thanh toán</text>
                            }
                            else
                            {
                                    <text>Đã khóa</text>
                            }
                        </button>
                    </form>
                </div>
            </div>            
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function() {
            // Khởi tạo tooltip
            $('[data-bs-toggle="tooltip"]').tooltip();

            // Auto-hide alerts after 5 seconds
            setTimeout(function() {
                $('.alert').alert('close');
            }, 5000);

            // AJAX form submission - chỉ submit nếu form enabled
            $('.ajax-form').submit(function(e) {
                e.preventDefault();

                const form = $(this);
                const submitBtn = form.find('button[type="submit"]');

                // Kiểm tra nếu form bị disabled thì không submit
                if (submitBtn.prop('disabled')) {
                    return false;
                }

                const originalText = submitBtn.html();
                const successMessage = form.data('success-message');

                // Disable button and show loading
                submitBtn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin me-1"></i>Đang xử lý...');

                $.ajax({
                    url: form.attr('action'),
                    type: 'POST',
                    data: form.serialize(),
                    success: function(response) {
                        showAlert('success', successMessage);
                        // Reload page after 1.5 seconds to reflect changes
                        setTimeout(() => location.reload(), 1500);
                    },
                    error: function(xhr) {
                        let errorMessage = 'Có lỗi xảy ra khi cập nhật';
                        if (xhr.responseJSON && xhr.responseJSON.error) {
                            errorMessage = xhr.responseJSON.error;
                        }
                        showAlert('danger', errorMessage);
                    },
                    complete: function() {
                        submitBtn.prop('disabled', false).html(originalText);
                    }
                });
            });
        });

        function showAlert(type, message) {
            const alertClass = type === 'success' ? 'alert-success' : 'alert-danger';
            const icon = type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle';

            const alertHtml = `
                <div class="alert ${alertClass} alert-dismissible fade show" role="alert">
                    <i class="fas ${icon} me-2"></i>${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;

            // Remove existing alerts
            $('.alert').alert('close');
            // Prepend new alert
            $('.container-fluid').prepend(alertHtml);
        }

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(function() {
                showAlert('success', 'Đã sao chép mã booking vào clipboard!');
            }, function() {
                showAlert('danger', 'Không thể sao chép mã booking');
            });
        }
    </script>
}

@functions {
    private string GetBookingStatusText(BookingStatus? status)
    {
        return status switch
        {
            BookingStatus.Pending => "Chờ xác nhận",
            BookingStatus.Confirmed => "Đã xác nhận",
            BookingStatus.Completed => "Hoàn thành",
            BookingStatus.Cancelled => "Đã hủy",
            _ => "Không xác định"
        };
    }

    private string GetPaymentStatusText(PaymentStatus? status)
    {
        return status switch
        {
            PaymentStatus.Pending => "Chờ thanh toán",
            PaymentStatus.Completed => "Đã thanh toán",
            PaymentStatus.Refunded => "Đã hoàn tiền",
            _ => "Không xác định"
        };
    }

    private string GetBookingStatusBadge(BookingStatus? status)
    {
        return status switch
        {
            BookingStatus.Pending => "bg-warning",
            BookingStatus.Confirmed => "bg-info",
            BookingStatus.Completed => "bg-success",
            BookingStatus.Cancelled => "bg-danger",
            _ => "bg-secondary"
        };
    }

    private string GetPaymentStatusBadge(PaymentStatus? status)
    {
        return status switch
        {
            PaymentStatus.Pending => "bg-warning",
            PaymentStatus.Completed => "bg-success",
            PaymentStatus.Refunded => "bg-secondary",
            _ => "bg-secondary"
        };
    }

    private bool IsBookingEditable(BookingStatus? bookingStatus, PaymentStatus? paymentStatus)
    {
        // Booking có thể chỉnh sửa khi:
        // - BookingStatus KHÔNG phải Completed hoặc Cancelled
        // - PaymentStatus KHÔNG phải Refunded
        return bookingStatus != BookingStatus.Completed &&
               paymentStatus != PaymentStatus.Refunded;
    }
}